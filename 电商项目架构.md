

# 项目介绍

- 商城是一个全品类的电商购物网站,没有第三方商家入驻
- 用户可以在线购买商品、加入购物车、下单、秒杀商品
- 可以评论已购买商品
- 管理员可以在后台管理商品的上下架、促销活动
- 管理员可以监控商品销售状况
- 客服可以在后台处理退款操作
- 希望未来3到5年可以支持千万用户的使用

## 前台:前台系统主要使用Nuxt结合Vue完成页面开发

1. 前台门户面向的是客户

   > 搜索商品
   >
   > 加入购物车
   >
   > 下单
   >
   > 评价商品等等

## 中台:

### 		nginx

- ​			前台发送请求,请求的是nginx,nginx做反向代理(端口转发[manage.mrshop.com:80-->127.0.0.1:9001 | api.mrshop.com:80 --> 127.0.0.1:8088{zuul}])

- ​		zuul

- ​			/api-xxx/** --> xxx-server服务

- ##### 	---本地域名解析

  ##### 		Windows下的hosts文件地址：C:/Windows/System32/drivers/etc/hosts

  ##### 		Linux下的hosts文件所在路径： /etc/hosts

  ###### 添加：

  127.0.0.1 api.mrshop.com 

  127.0.0.1 manage.mrshop.com

  --127.0.0.1 api.mrshop.com ：我们的网关Zuul

  --127.0.0.1 manage.shop.com：我们的后台系统地址

  ###### 测试域名是否畅通：ping api.mrshop.com 

  ###### 解压 mrshop-manage-web.rar到vscode工作空间

  打开build文件夹下webpack.dev.conf.js文件在devServer下加入

  ###### disableHostCheck: true,

## 后台:

后台系统主要包含以下功能： 

- 商品管理，包括商品分类、品牌、商品规格等信息的管理 
- 销售管理，包括订单统计、订单退款处理、促销活动生成等 
- 用户管理，包括用户控制、冻结、解锁等 权限管理，整个网站的权限控制，采用JWT鉴权方案，对用户及API进行权限控制 
- 统计，各种数据的统计分析展示

# 基础架构

## 一丶创建父项目

-   ---------- mingrui-shop-parent 

-   ----------- 删除src目录


### pom.xml

```properties
<packaging>pom</packaging>

<properties>
    <!--项目构建编码-->
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF- 8</project.reporting.outputEncoding>
    <!--声明JDK版本-->
    <java.version>1.8</java.version>
    <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
    <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
</properties>

<!--boot 版本-->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.1.RELEASE</version>
    <!--始终从仓库中获取，不从本地路径获取-->
    <relativePath />
</parent>

<dependencies>
    <!-- 集成commons工具类 -->
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>
    <!-- 集成lombok 框架 -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <!--junit测试-->
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
    </dependency>
    <!-- SpringBoot整合eureka客户端 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    <!--boot 测试模块-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>

<!-- 项目依赖,子级模块可以继承依赖-->
<dependencyManagement>
    <dependencies>
        <!--cloud 依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${mr.spring.cloud.version}</version>
            <type>pom</type>
            <!--解决maven单继承的问题-->
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
<repositories>
    <repository>
        <id>spring-milestones</id>
        <name>Spring Milestones</name>
        <url>https://repo.spring.io/libs-milestone</url>
        <snapshots>
            <enabled>false</enabled>
        </snapshots>
    </repository>
</repositories>
```

###### 	

## 二丶在父项目(mingrui-shop-parent)下创建基础服务父工程

- ### 		--------------------- mingrui-shop-basics

- ###         --------------------- 删除src目录


### pom.xml



```properties
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```

## 

## 三丶在父项目(mingrui-shop-parent)下创建公共(工具)工程

- ### 		----------------------- mingrui-shop-commoms

- ### 		----------------------- 删除src 目录


### pom.xml

```properties
<!--父级项目不需要打包所有packging的类型为pom-->
<packaging>pom</packaging>
```

###   

## 四丶在父项目(mingrui-shop-parent)下创建服务实现工程

- ### 		------------------------  mingrui-shop-service

- ### 		----------------------- 删除src 目录


### pom.xml

```properties
<!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <scope>runtime</scope><!--项目运行阶段使用-->
            <version>5.1.38</version>
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
```



## 五丶在父项目(mingrui-shop-parent)下创建服务接口工程

- ### 		-------------------- mingrui-shop-service-api

- ### 		----------------------- 删除src 目录


### pom.xml

```properties
<!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <modules>
        <module>mingrui-shop-service-api-xxx</module>
    </modules>
    <dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--Entity 中的@Table 和@Id需要次注解-->
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0.2</version>
        </dependency>
        <!--2.3版本之后web删除了验证插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--引入common工程代码-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
    </dependencies>
```





# 子服务工程

### 一丶基础服务父工程项目(mingrui-shop-basics)

#### 		1.在mingrui-shop-basics创建mingrui-shop-basic-eureka-server服务

##### 			pom.xml

​		

```properties
<dependencies>
    <!--eureka 服务依赖-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

##### 			yml

```properties
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false
```

##### 			创建com.baidu包

##### 			启动类(RunEurekaServerApplication) 

```properties
启动类注解:
	@SpringBootApplication
	@EnableEurekaServer
```

####      	2.在mingrui-shop-basics创建mingrui-shop-basic-zuul-server服务	

##### 			pom.xml

​		

```properties
<dependencies>
    <!-- zuul -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
    </dependency>
</dependencies>
```

##### 			yml(application.yml)

```properties
server:
  port: 8088
spring:
  application:
    name: eureka-zuul
zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
     # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
#配置负载
ribbon:
  ConnectTimeout: 250 # 连接超时时间(ms)
  ReadTimeout: 2000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数

hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

##### 			创建com.baidu包

##### 			启动类(RunZuulServerApplication) 

```properties
启动类注解:  
    @SpringBootApplication
    @EnableZuulProxy
    @EnableEurekaClient
```

#####       	在com.baidu下建global.GlobalCorsConfig类(解决跨域)

```java

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new
                UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
//3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```

#### 3.在mingrui-shop-basics创建mingrui-shop-basic-upload-server文件上传服务

##### pom.xml

```properties
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shop-common-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

##### com.baidu下创建启动类RunUploadServerApplication

```
@SpringBootApplication
@EnableEurekaClient
```

##### com.baidu.shop.upload.controller包下建类UploadController

```java
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.util.UUID;

@RestController
@RequestMapping(value = "upload")
public class UploadController extends BaseApiService {
    //linux系统的上传目录
    @Value(value = "${mingrui.upload.path.windows}")
    private String windowsPath;

    //window系统的上传目录
    @Value(value = "${mingrui.upload.path.linux}")
    private String linuxPath;

    @Value(value = "${mingrui.upload.img.host}")
    private String imageHost;

    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) {

        if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的文件是否为空

        String filename = file.getOriginalFilename();//获取文件名

        //String path = "";
        String os = System.getProperty("os.name").toLowerCase();
        String path = os.indexOf("win") != -1 ? windowsPath : os.indexOf("lin") != -1 ? linuxPath : "";

        //UUID.randomUUID() + 1.jpg UUID.randomUUID() + 1.jpg
        filename = UUID.randomUUID() + filename;//防止文件名重复

        //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
        File dest = new File(path + File.separator + filename);

        //判断文件夹是否存在,不存在的话就创建
        if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();

        try {
            file.transferTo(dest);//上传
        } catch (IllegalStateException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }

        return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/" + filename);//将文件名返回页面用于页面回显
    }
}
```

##### com.baidu.global包下建GlobalCorsConfig类(解决跨域)

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();

        config.setAllowCredentials(true); // 允许cookies跨域

        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。

        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部

        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了

        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等

        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);

        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }
}
```

### 二丶公共(工具)工程(mingrui-shop-commoms)

#### 		1.在mingrui-shop-commoms下创建mingrui-shop-common-core项目

##### 				pom.xml

```properties
<dependencies>
    <!--处理json与各种数据类型或文档类型的转换-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
        <version>2.8.5</version>
    </dependency>
    <!--json对象序列化和反序列化的支持-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
    <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-lgpl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--java对象和json对象之间的转换-->
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-core-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <dependency>
        <groupId>org.codehaus.jackson</groupId>
        <artifactId>jackson-mapper-asl</artifactId>
        <version>1.9.13</version>
    </dependency>
    <!--alibaba的json处理工具-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>fastjson</artifactId>
        <version>1.2.62</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.11.2</version>
    </dependency>
</dependencies>
```

##### 				建com.baidu.shop.base/status/utils包

##### 				base

###### 		1)BaseApiService类

```java
package com.baidu.shop.base;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: 接口的实现类继承此类
 * @Author shenyaqi
 * @Date 2020/8/17
 * @Version V1.0
 **/
@Data
@Component
@Slf4j
public class BaseApiService<T> {
    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , msg : %s , data : %s}",code,msg,
                JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }
}
```

###### 		2)Result类

```java
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;
/**
 * @ClassName Result
 * @Description: 统一返回
 * @Author shenyaqi
 * @Date 2020/8/17
 * @Version V1.0
 **/
@Data
@NoArgsConstructor
public class Result<T> {
    private Integer code;//返回码
    private String message;//返回消息
    private T data;//返回数据
    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }
}
```

##### status

###### 		HTTPStatus

```java
package com.baidu.shop.status;
/**
 * * @ClassName HTTPStatus
* @Description: TODO
* @Author shenyaqi
* @Date 2020/8/17
* @Version V1.0
**/

public class HTTPStatus {
    public static final int OK = 200;//成功
    public static final int ERROR = 500;//失败
}
```

##### utils

​		JSONUtil

```java
package com.baidu.shop.utils;/**
 * @program: mingrui-shop-parent
 * @description:
 * @author: zzx
 * @create: 2020-12-22 14:51
 */

import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author 王某人
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class JSONUtil {
    private static Gson gson = null;
    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();// todo yyyy-MM-dd HH:mm:ss
    }
    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }
    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }
    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }
    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }
    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }
    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }
    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }
    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }
    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }
    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }
    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }

    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }
    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }
    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }
}
```

###### 		ObjectUtil

```java
package com.baidu.shop.utils;

public class ObjectUtil {
    public static Boolean isNull(Object obj){
        return null == obj;
    }

    public static Boolean isNotNull(Object obj){
        return null != obj;
    }
}
```

### 三丶服务接口工程(mingrui-shop-service-api)

#### 		1.在mingrui-shop-service-api建mingrui-shop-service-api-xxx项目

###### 	pom.xml

```properties
<dependencies>
    <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>
    <!--提供可视化的API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <version>2.9.2</version>
    </dependency>

</dependencies>
```

#### 		2.建包com.baidu.shop 在此包下建config包

###### 		config下建MrSwaggerConfig类

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;
/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author shenyaqi
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Configuration
@EnableSwagger2
public class MrSwagger2Config {


    @Bean
    public Docket createRestApi(){
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }

    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("shenyaqi","baidu.com","shenyaqiii@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }
}
```

###### 		



### 四丶服务实现工程(mingrui-shop-service)

##### 		1.在mingrui-shop-service下创建mingrui-shop-service-xxx项目

###### 		pom.xml 默认

##### yml

```
server:
  port: 8100

spring:
  application:
    name: xxx-server
  # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://localhost:3306/qxf?useSSL=true&nullNamePatternMatchesAll=true&serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存活时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000
# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
#日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

##### 2.建com.baidu包 在此包下建启动类RunXXXApplication

注解
	@SpringBootApplication
    @EnableEurekaClient
    @MapperScan("com.baidu.shop.mapper")



# category商品分类

## 查:

#### 1.在mingrui-shop-service-api-xxx服务中的com.baidu.shop下分别创建entity

#### 2.在entity包下建CategoryEntity实体类

​		

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

@Table(name = "tb_spec_group")
@Data
public class SpecGroupEntity {

    @Id
    private Integer id;

    private String name;

    private Integer cid;
}
```

#### 3.在service包下建CategoryServiceI接口

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;

import org.springframework.web.bind.annotation.*;

@Api(tags = "商品分类接口")
public interface CategoryServiceI {
    
    @ApiOperation(value = "通过pid查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

}
```

#### 4.在mingrui-shop-service-xxx服务的com.baidu包下建shop.mapper包

#### 5.在mapper包下建CategoryMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import tk.mybatis.mapper.common.Mapper;

public interface CategoryMapper extends Mapper<CategoryEntity> {

}
```

#### 6.在mingrui-shop-service-xxx服务的com.baidu包下建shop.service.impl包

#### 7.在impl下建CategoryServiceImpl实现类

```java
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryServiceI {
	
	@Resource
    private CategoryMapper categoryMapper;
	
	@Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {

      	CategoryEntity categoryEntity = new CategoryEntity();

        categoryEntity.setParentId(pid);

        List<CategoryEntity> list = categoryMapper.select(categoryEntity);

        return this.setResultSuccess(list);
    }
}
```

## 删:

##### 	思路:

- 判断传来的id是否合法
- 根据id查询一条数据
- 判断查询的数据是否存在
- 判断该数据的状态是否为父节点
- 根据概述的parentId查询数据,返回一个list数组
- 判断list的长度是否小于等于1( true : 执行删除操作, false:修改其父节点状态(isParent = 0))

#### 1.接口

```java
@ApiOperation(value = "通过id删除商品分类")
@DeleteMapping(value = "/category/delete")
Result<JsonObject> deleteCategoryById(Integer id);
```

#### 2.实现类中

```java
@Override
@Transactional //控制事务
public Result<JsonObject> deleteCategoryById(Integer id) {
    //id校验
    if(ObjectUtil.isNull(id) || id <= 0) return this.setResultError(HTTPStatus.OPERATION_ERROR,"id不合法");

    //通过id查询当前节点数据
    CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

    //判断当前数据是否为空
    if(ObjectUtil.isNull(categoryEntity)) return this.setResultError(HTTPStatus.OPERATION_ERROR,"数据不存在");

    //判断当前节点是否为父节点
    if(categoryEntity.getIsParent() == 1) return this.setResultError(HTTPStatus.OPERATION_ERROR,"当前节点为父节点,不能被删除");

    //如果当前分类被品牌绑定,该分类不能被删除
    Example example1 = new Example(CategoryBrandEntity.class);
    example1.createCriteria().andEqualTo("categoryId",id);
    List<CategoryBrandEntity> select = categoryBrandMapper.selectByExample(example1);

    if(select.size() >= 1) return this.setResultError("该分类已经被其他品牌绑定,不能被删除");

    //查询当前节点的父节点下有没有其他子节点
    Example example = new Example(CategoryEntity.class);
    example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());
    List<CategoryEntity> list = categoryMapper.selectByExample(example);

    if(list.size() <= 1){

        CategoryEntity updateCategoryEntity = new CategoryEntity();
        updateCategoryEntity.setIsParent(0);
        updateCategoryEntity.setId(categoryEntity.getParentId());

        categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
    }

    categoryMapper.deleteByPrimaryKey(id);

    return this.setResultSuccess();
}
```

## 改:

#### 1.接口

```java
@ApiOperation(value = "通过id更新商品分类name")
@PutMapping(value = "/category/update")
Result<JsonObject> updateCategoryNameById(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity categoryEntity);
```

#### 2.实现类

```java
@Override
@Transactional
public Result<JsonObject> updateCategoryNameById(CategoryEntity categoryEntity) {

    categoryMapper.updateByPrimaryKeySelective(categoryEntity);

    return this.setResultSuccess();
}
```

## 增:

##### 	思路:

- 根据根据新增节点的父id查询父节点信息
- 判断新增节点的父节点的状态是不是父节点
- 如果父节点的状态不是父节点,将其修改为父节点
- 否则直接新增

#### 1.接口

```java
@ApiOperation(value = "新增商品分类")
@PostMapping(value = "/category/save")
Result<JsonObject> saveCategoryNameById(@Validated(MingruiOperation.Add.class) @RequestBody CategoryEntity categoryEntity);
```

#### 2.实现类

```java
@Transactional//控制事务
@Override
public Result<JsonObject> saveCategoryNameById(CategoryEntity categoryEntity) {

    //根据新增节点的父id查询父节点信息
    CategoryEntity parentCategoryEntity = categoryMapper.selectByPrimaryKey(categoryEntity.getParentId());
    //判断新增节点的父节点的状态是不是父节点
    if(parentCategoryEntity.getIsParent() != 1) {

        CategoryEntity categoryEntity1 = new CategoryEntity();
        categoryEntity1.setId(categoryEntity.getParentId());
        categoryEntity1.setIsParent(1);
        //如果父节点的状态不是父节点,将其修改为父节点
        categoryMapper.updateByPrimaryKeySelective(categoryEntity1);

    }
    //新增节点
    categoryMapper.insertSelective(categoryEntity);

    return this.setResultSuccess();
}
```

# brand品牌管理

### 1.在base包下新建BaseDTO

```java
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页", example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页显示多少条",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){
        return sort + " " +(Boolean.valueOf(order) ? "desc" : "asc");
    }

}
```

## 2.mingrui-shop-api-xxx

- #### 在com.baidu.shop下新建dto包

  ##### 在dto包下建BrandDTO类

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @ApiModelProperty(value = "品牌主键",example = "1")
    @NotNull(message = "品牌主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "品牌LOGO")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

    @ApiModelProperty(value = "商品类别id集合")
    private String categories;
}
```

### 3.在entity包下建实体类

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

@Data
@Table(name = "tb_brand")
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}
```

## 查:

#### 1.在mingrui-shop-api-xxx服务中的service包下建BrandServiceI接口

```java
@Api(tags = "商品品牌接口")
public interface BrandServiceI{
    @ApiOperation(value="查询商品品牌")
    @GetMapping(value = "/brand/list")
    Result<PageInfo<BrandEntity>> getBrandList(BrandDTO brandDTO);
}
```

#### 2.在mingrui-shop-service-xxx的mapper包下建BrandMapperj接口

```java
public interface BrandMapper extends Mapper<BrandEntity> {}
```

#### 3.在mingrui-shop-service-xxx的impl包下建BrandServiceImpl实现类

```java
@RestController
public class BrandServiceImpl extends BaseApiService implements BrandServiceI {
     @Resource
    private BrandMapper brandMapper;
      @Override
    public Result<PageInfo<BrandEntity>> getBrandList(BrandDTO brandDTO) {

        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        //排序
        if(ObjectUtil.isNotNull(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);

        //模糊查询
        Example example = new Example(BrandEntity.class);
        example.createCriteria().andLike("name","%"+ brandEntity.getName() +"%");

        List<BrandEntity> brandEntities = brandMapper.selectByExample(example);
        //总条数
        PageInfo<BrandEntity> pageInfo = new PageInfo<>(brandEntities);

        return this.setResultSuccess(pageInfo);
    }
}
```

## 增:

#### 1.BrandServiceI接口方法

```java
@ApiOperation(value="新增商品品牌")
@PostMapping(value = "/brand/save")
Result<JSONObject> saveBrand(@RequestBody BrandDTO brandDTO);
```

#### 2.BrandServiceImpl实现类方法

```java
@Override
@Transactional
public Result<JSONObject> saveBrand(BrandDTO brandDTO) {

    //新增返回主键
    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
    //处理首字母
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);

    brandMapper.insertSelective(brandEntity);

    //维护中间表
    this.insertCategoryBrandInfo(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

## 删:

#### 1.BrandServiceI接口方法

```java
@ApiOperation(value="删除商品品牌")
@DeleteMapping(value = "/brand/delete")
Result<JSONObject> deleteBrand(Integer id);
```

#### 2.BrandServiceImpl实现类方法

```java
@Override
@Transactional
public Result<JSONObject> deleteBrand(Integer id) {

    //删除商品品牌
    brandMapper.deleteByPrimaryKey(id);
    //先通过brandId删除中间表的数据
    this.deleteCategoryByBrandId(id);

    return this.setResultSuccess();
}
```

## 改:

#### 1.BrandServiceI接口方法

```java
@ApiOperation(value="修改商品品牌")
@PutMapping(value = "/brand/save")
Result<JSONObject> editBrand(@RequestBody BrandDTO brandDTO);
```

#### 2.BrandServiceImpl实现类方法

```java
@Override
@Transactional
public Result<JSONObject> editBrand(BrandDTO brandDTO) {

    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
    //处理品牌首字母
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName()
            .toCharArray()[0]), false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);

    //先通过brandId删除中间表的数据
   this.deleteCategoryByBrandId(brandEntity.getId());

   this.insertCategoryBrandInfo(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

# 规格组

## 查询

### 1.前台

```js
loadData(){
          this.$http.get("/spec/list/?cid=" + this.cid)
          .then((resp) => {
              this.groups = resp.data.data;
          })
          .catch(() => {
              this.groups = [];
          })
      },
```

### 2.接口

```java
@ApiOperation("规格组查询")
@GetMapping("spec/list/")
Result<List<SpecificationEntity>> getSpecicationList(SpecificationDTO specificationDTO);
```

### 3.实体类SpecificationEntity

```java
@Table(name = "tb_spec_group")
@Data
public class SpecificationEntity {

    @Id
    private Integer id;

    private Integer cid;

    private String name;


}
```

### 4.规格组DTO

```java
@Data
@ApiModel(value = "规格组传递DTO")
public class SpecificationDTO extends BaseDTO {

    @Id
    @ApiModelProperty(value = "主键", example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "类型ID",example = "1")
    @NotNull(message = "类型Id不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(value = "规格组名称")
    @NotEmpty(message = "规格组名称不能为空",groups = {MingruiOperation.Add.class})
    private String name;

}
```

### 5.实现类

用Example进行条件查询

DTO接受的前台参数，赋值给实体类（实体都是无参数的）让实体类去数据库查询

并返回list集合

```java
@Override
public Result<List<SpecificationEntity>> getSpecicationList(SpecificationDTO specificationDTO) {

    Example example = new Example(SpecificationEntity.class);
    
    example.createCriteria().andEqualTo("cid",
         BaiduBeanUtil.copyProperties(specificationDTO,
                                      SpecificationEntity.class).getCid()
         );

    List<SpecificationEntity> list = specificationMapper.selectByExample(example);

    return this.setResultSuccess(list);
}
```

### 6.mapper接口

```java
public interface SpecificationMapper extends Mapper<SpecificationEntity> {
}
```

## 新增

### 1.前台

```js
save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/spec/save/',
            data: this.group
          }).then(() => {
              this.show = false;
              this.$message.success("保存成功！");
              this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      }
```

### 2.接口

后台接受前台传递的‘’数据‘’（参数）时都需要在接口上添加@RequestBody注解。

```java
@ApiOperation("规格组新增")
@PostMapping("spec/save/")
Result<JSONObject> addSpecification(@RequestBody SpecificationDTO specificationDTO);
```

### 3.实现类

DTO接口的参数赋值给实体进行查询操作就可以了

```java
@Override
@Transactional
public Result<JSONObject> addSpecification(SpecificationDTO specificationDTO) {

    specificationMapper.insertSelective(
            BaiduBeanUtil.copyProperties(specificationDTO,SpecificationEntity.class));

    return this.setResultSuccess();
}
```

## 修改

### 1.前台发送请求到后台和新增用同一个请求

根据RestFul风格区分

### 2.接口

```java
@ApiOperation("规格组修改")
@PutMapping("spec/save/")
Result<JSONObject> updateSpecification(@RequestBody SpecificationDTO specificationDTO);
```

### 3.实现类

DTO接口的参数赋值给实体进行修改操作

```java
@Override
@Transactional
public Result<JSONObject> updateSpecification(SpecificationDTO specificationDTO) {
    specificationMapper.updateByPrimaryKeySelective(
            BaiduBeanUtil.copyProperties(specificationDTO,SpecificationEntity.class));
    return this.setResultSuccess();
}
```

## 删除

### 1.前台请求后台

```js
deleteGroup(id){
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("/spec/delete/" + id)
                .then((resp) => {
                  if(resp.data.code != 200){
                    this.$message.error("删除失败")
                    return ;
                  }
                    this.$message.success("删除成功");
                    this.loadData();
                })
          })
      },
```

### 2.接口

这个方式是RestFul风格传递参数 需要加@PathVariable注解

这个注解@PathVariable(name="") 默认的name属性，需要和@DeleteMapper（/////{id}）里面的参数一致

接口参数和前台发送的参数一致也可以，不过必须加注解

```java
@ApiOperation("规格组删除")
@DeleteMapping("spec/delete/{id}")
Result<JSONObject> deleteSpecification(@PathVariable Integer id);
```

### 3.实现类

直接进行删除操作就可以了

```java
@Override
public Result<JSONObject> deleteSpecification(Integer id) {
    //Example example = new Example(SpecParamEntity.class);
    //example.createCriteria().andEqualTo("groupId",id);
    //List<SpecParamEntity> entities = specParamMapper.selectByExample(example);
    //if(entities.size() >= 1) return this.setResultError("规格组内存在参数，不能删");
    specificationMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

## 分类管理的删除优化

在CategoryServiceImpl包下 的deleteCategoryById方法中加入

```java
//查询删除节点绑定的品牌,存在的话不能被删除
Example example1 = new Example(CategoryBrandEntity.class);
example1.createCriteria().andEqualTo("categoryId", id);
List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
if(categoryBrandEntities.size() >= 1) return setResultError("此节点被品牌绑定,不能被删除");
```

# 规格组参数

## 规格组参数查询

### 1.前台发送请求并传递id

```js
loadData() {
      this.$http
        .get("/param/list/",{
          params:{
          groupId:this.group.id
        }})
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

### 2.实体类

```java
@Data
@Table(name = "tb_spec_param")
public class SpecParamEntity {

    @Id
    private Integer id;
    private Integer cid;
    private Integer groupId;
    private String name;
	//因为numeric在数据库是个关键字  所以需要在实体中声明一下这个列
    @Column(name = "`numeric`")
    private Boolean numeric;
    private String unit;
    private Boolean generic;
    private Boolean searching;
    private String segments;
}
```

### 3.规格参数DTO

```java
@Data
@ApiModel("规格参数传递DTO")
public class SpecParamDTO {

    @Id
    @ApiModelProperty(name = "主键",example = "1")
    @NotNull(message = "id不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(name="cid",example = "1")
    @NotNull(message = "cid不能为空",groups = {MingruiOperation.Add.class})
    private Integer cid;

    @ApiModelProperty(name="groupId",example = "1")
    @NotNull(message = "groupId不能为空",groups = {MingruiOperation.Add.class})
    private Integer groupId;

    @ApiModelProperty(name="name不能为空")
    @NotEmpty(message = "name不能为空",groups = {MingruiOperation.Add.class})
    private String name;

    
    //因为numeric在数据库是个关键字  所以需要在实体中声明一下这个列
    @ApiModelProperty(name="numeric",example = "1")
    @Column(name = "`numeric`")
    private Boolean numeric;

    @ApiModelProperty(name="unit")
    @NotEmpty(message = "unit不能为空",groups = {MingruiOperation.Add.class})
    private String unit;

    @ApiModelProperty(name="generic")
    private Boolean generic;

    @ApiModelProperty(name="searching")
    private Boolean searching;

    @ApiModelProperty(name = "segments")
    @NotEmpty(message = "segments不能为空",groups = {MingruiOperation.Add.class})
    private String segments;
}
```

### 4.接口

实体接收并返回List集合

```java
@ApiOperation("规格组参数查询")
@GetMapping("param/list/")
Result<List<SpecParamEntity>> getParamList(SpecParamDTO specParamDTO);
```

### 5.实现类

规格组参数表中 有规格组的外键,通过groupId 查询 规格组中各个规格组的参数

tb_spec_group规格组表

tb_spec_param规格组参数表

规格组表中的参数全部放在了规格组参数表中

前台传递的是规格组表的id  ,根据规格组表的id在规格组参数表中查询对应所存在的数据,并返回集合

```java
@Override
public Result<List<SpecParamEntity>> getParamList(SpecParamDTO specParamDTO) {

    SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
    Example example = new Example(SpecParamEntity.class);
    example.createCriteria().andEqualTo("groupId", specParamEntity.getGroupId());
    List<SpecParamEntity> paramEntities = specParamMapper.selectByExample(example);

    return this.setResultSuccess(paramEntities);
}
```

### 6.mapper接口

```java
public interface SpecParamMapper extends Mapper<SpecParamEntity> {
}
```

## 新增

### 1.前台

```
save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/param/save/',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
```

### 2.接口

```java
@ApiOperation("规格组参数新增")
@PostMapping("param/save/")
Result<JSONObject> getParamAdd(@RequestBody SpecParamDTO specParamDTO);
```

### 3.实现类

把DTO接受的数据传给实体进行操作数据库

```java
@Override
@Transactional
public Result<JSONObject> getParamAdd(SpecParamDTO specParamDTO) {
    specParamMapper.insertSelective(
            BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
    return this.setResultSuccess();
}
```

## 修改

### 1.接口

```java
@ApiOperation("规格组参数修改")
@PutMapping("param/save/")
Result<JSONObject> getParamEdit(@RequestBody SpecParamDTO specParamDTO);
```

### 2.实现类

把DTO接受的数据传给实体进行操作数据库

```java
@Override
@Transactional
public Result<JSONObject> getParamEdit(SpecParamDTO specParamDTO) {
    specParamMapper.updateByPrimaryKeySelective(
            BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
    return this.setResultSuccess();
}
```

## 删除

### 1.前台

```js
deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("/param/delete/?id=" + id)
            .then(() => {
                this.$message.success("删除成功");
                this.loadData();
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
```

### 2.接口

```java
@ApiOperation("规格组参数删除")
@DeleteMapping("param/delete")
Result<JSONObject> getParamDelete(Integer id);
```

### 3.实现类

直接拿id进行删除

```java
//规格组参数CRUD
@Override
@Transactional
public Result<JSONObject> getParamDelete(Integer id) {
    specParamMapper.deleteByPrimaryKey(id);
    return this.setResultSuccess();
}
```

#### 规格组删除优化

如果规格组中存在参数就不能被删除

判断 如果规格组中数据非0时就不能被删除

```java
Example example = new Example(SpecParamEntity.class);
example.createCriteria().andEqualTo("groupId",id);
List<SpecParamEntity> entities = specParamMapper.selectByExample(example);
if(entities.size() >= 1) return this.setResultError("规格组内存在参数，不能删");
```

# 商品管理

#### 四张表的关系:

![Snipaste_2021-01-08_22-01-16](D:\2005实训\6月份\md总结文档\Snipaste_2021-01-08_22-01-16.png)

### 一丶查询

#### 1.在entity下建SpuEntity实体类

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Data
@Table(name = "tb_sku")
public class SkuEntity {

    @Id//此处写成long类型,新增的id超过int的取值范围
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Integer enable;

    private Date createTime;

    private Date lastUpdateTime;

}
```

#### 2.dto包下建spuDTO类

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

@ApiModel(value = "Spu数据传输DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "spu主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotNull(message = "标题不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private String title;

    @NotNull(message = "子标题不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "1级类目id不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id",example = "1")
    @NotNull(message = "2级类目id不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id",example = "1")
    @NotNull(message = "3级类目id不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer cid3;

    @ApiModelProperty(value = "商品所属品牌id",example = "1")
    @NotNull(message = "商品所属品牌id不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Integer brandId;

    @NotNull(message = "商品是否上下架不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "是否上架，0下架，1上架",example = "1")
    private Integer saleable;

    @NotNull(message = "商品是否有效不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "是否有效，0已删除，1有效",example = "1")
    private Integer valid;

    @NotNull(message = "创建时间不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @NotNull(message = "最后修改时间不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "最后修改的时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;

    @NotNull(message = "spuDetail不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    @ApiModelProperty(value = "大字段数据")
    private SpuDetailDTO spuDetail;

    @ApiModelProperty(value = "sku属性数据集合")
    private List<SkuDTO> skus;

}
```

#### 3.在mingrui-shop-api-xxx服务中的service包下建GoodsServiceI接口

```java
@Api(tags = "商品接口")
public interface GoodsServiceI {
    @ApiOperation(value = "获取spu信息")
    @GetMapping(value = "/goods/spuInfo")
    Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO);
}
```

#### 4.在mingrui-shop-service-xxx的mapper包下建SpuMapper接口

```java
public interface SpuMapper extends Mapper<SpuEntity> {
}
```

#### 5.在mingrui-shop-service-xxx的impl包下建GoodsServiceImpl实现类

```java
@RestController
@Slf4j
public class GoodsServiceImpl extends BaseApiService implements GoodsServiceI {
    
    @Resource
    private SpuMapper spuMapper;
    
    @Resource 
    private BrandMapper brandMapper; 
    
    @Resource 
    private CategoryMapper categoryMapper;
    
     @Override
    @Transactional
    public Result<List<SpuDTO>> getSpuInfo(SpuDTO spuDTO) {
        //分页
        if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        //排序
        if(!StringUtils.isEmpty(spuDTO.getSort()) && !StringUtils.isEmpty(spuDTO.getOrder()))
            PageHelper.orderBy(spuDTO.getOrderBy());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable", spuDTO.getSaleable());
        if(!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title","%"+spuDTO.getTitle()+"%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList = spuEntities.stream().map(spuEntity -> {
            //返回类型是SpuDTO 所以讲spuEntity copy 到 SpuDTO
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);

            //通过商品分类id集合查询数据
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(),
                    spuEntity.getCid2(), spuEntity.getCid3()));

            //遍历categoryEntities集合将分类名称用 / 拼接
            String categoryName = categoryEntities.stream().map(categoryEntity ->
                    categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            // 根据brandId查询数据
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> pageInfo = new PageInfo<>(spuEntities);

        return this.setResult(HTTPStatus.OK,pageInfo.getTotal()+ "",spuDTOList);
    }
}
```

#### 6.修改CategoryMapper接口

```java
public interface CategoryMapper extends Mapper<CategoryEntity>, SelectByIdListMapper<CategoryEntity,Integer> {
    @Select(value="select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

### 二丶